name: Daily Economic Terms

on:
  schedule:
    # ë§¤ì¼ ì•„ì¹¨ 8ì‹œ (í•œêµ­ì‹œê°„) = UTC 23:00 (ì „ë‚ )
    - cron: '0 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  send-daily-terms:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Send Daily Terms to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');
          
          // í™˜ê²½ ë³€ìˆ˜
          const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
          const CHANNEL = process.env.TELEGRAM_CHANNEL;
          
          // terms.json ë¡œë“œ
          const terms = JSON.parse(fs.readFileSync('./terms.json', 'utf8'));
          
          // ì‹œì‘ì¼ ê¸°ì¤€ í˜„ì¬ Day ê³„ì‚°
          const START_DATE = new Date('2025-01-01');
          const today = new Date();
          const diffTime = today.getTime() - START_DATE.getTime();
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          const currentDay = (diffDays % Math.ceil(terms.length / 4)) + 1;
          
          // ì˜¤ëŠ˜ì˜ ìš©ì–´ 4ê°œ
          const startIdx = (currentDay - 1) * 4;
          const todayTerms = terms.slice(startIdx, startIdx + 4);
          
          if (todayTerms.length === 0) {
            console.log('No terms for today');
            process.exit(0);
          }
          
          // ë©”ì‹œì§€ ìƒì„±
          const termsList = todayTerms.map((t, i) => {
            const emoji = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£'][i];
            const simple = t.simpleExplanation || t.definition || '';
            return `${emoji} <b>${t.term}</b>\n${simple}`;
          }).join('\n\n');
          
          const message = `ğŸ“š <b>ì˜¤ëŠ˜ì˜ ê²½ì œê¸ˆìœµìš©ì–´ (Day ${currentDay})</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${termsList}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘‰ <a href="https://basic-economic-vocab.netlify.app/?day=${currentDay}">ìì„¸íˆ í•™ìŠµí•˜ê¸°</a>`;
          
          // í…”ë ˆê·¸ë¨ API í˜¸ì¶œ
          const data = JSON.stringify({
            chat_id: CHANNEL,
            text: message,
            parse_mode: 'HTML',
            disable_web_page_preview: false
          });
          
          const options = {
            hostname: 'api.telegram.org',
            path: `/bot${BOT_TOKEN}/sendMessage`,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(data)
            }
          };
          
          const req = https.request(options, (res) => {
            let body = '';
            res.on('data', chunk => body += chunk);
            res.on('end', () => {
              const result = JSON.parse(body);
              if (result.ok) {
                console.log(`âœ… Day ${currentDay} ë°œì†¡ ì„±ê³µ!`);
                console.log(`ìš©ì–´: ${todayTerms.map(t => t.term).join(', ')}`);
              } else {
                console.error('âŒ ë°œì†¡ ì‹¤íŒ¨:', result);
                process.exit(1);
              }
            });
          });
          
          req.on('error', (e) => {
            console.error('âŒ ì—ëŸ¬:', e);
            process.exit(1);
          });
          
          req.write(data);
          req.end();
          EOF
